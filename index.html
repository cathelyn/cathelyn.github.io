<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Heute kommt ein Gewitter</title>

<!--	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />-->
	<link rel="stylesheet" href="leaflet/leaflet.css" />
	<link rel="stylesheet" href="dist/LeafletStyleSheet.css" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
   integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
   crossorigin=""/>
	<script src="leaflet/leaflet.js"></script>
	<script src="dist/PruneCluster.js"></script>
	<script src="sources/traffic_accidents_date.js"></script>
	<script src="sources/bike_accidents_lat_lon_date.js"></script>
	<script src="sources/ped_accidents_lat_lon_date.js"></script>
	<script src="sources/pub_trans_stops_lat_lon_name.js"></script>
	<script src="sources/street_lights_lat_lon_date.js"></script>


	<style>
		html, body {
			height: 100%;
			margin: 0;
		}
		.leaflet-container {
			height: 400px;
			width: 600px;
			max-width: 100%;
			max-height: 100%;
		}
	</style>


</head>
<body>


<!--TODO: Use marker.filtered instead of removing markers from accident cluster -->

<div id="map" style="width: 100vw; height: 100vh;"></div>
<script>


	// one main layer group
	let accidents = L.layerGroup();


	// various accident type layers
	let traffic_accident_layer = L.layerGroup();
	let bike_accident_layer = L.layerGroup();
	let pedestrian_accident_layer = L.layerGroup();

	//accident attributes layers
	let year_layer = L.layerGroup();
	let month_layer = L.layerGroup();
	let day_layer = L.layerGroup();

	//another info layers
	let air_quality_layer = L.layerGroup();
	let paid_parking_layer = L.layerGroup();
	let pedestrian_crossings_layer = L.layerGroup();
	let public_transport_stops_layer = L.layerGroup();
	let street_lights_layer = L.layerGroup();
	let street_slopes_layer = L.layerGroup();


    let accidents_cluster = new PruneClusterForLeaflet(160);

	// icons for separate categories
	accidents_cluster.BuildLeafletClusterIcon = function(cluster) {
        var e = new L.Icon.MarkerCluster();

        e.stats = cluster.stats;
        e.population = cluster.population;
        return e;
    };

	var colors = ['rgba(255,75,0,0.6)', 'rgba(160,61,229,0.6)', 'rgba(3,170,234,0.6)'],
			pi2 = Math.PI * 2;

	L.Icon.MarkerCluster = L.Icon.extend({
		options: {
			iconSize: new L.Point(44, 44),
			className: 'prunecluster leaflet-markercluster-icon'
		},

		createIcon: function () {
			// based on L.Icon.Canvas from shramov/leaflet-plugins (BSD licence)
			var e = document.createElement('canvas');
			this._setIconStyles(e, 'icon');
			var s = this.options.iconSize;
			e.width = s.x;
			e.height = s.y;
			this.draw(e.getContext('2d'), s.x, s.y);
			return e;
		},

		createShadow: function () {
			return null;
		},

		draw: function(canvas, width, height) {
			var start = 0;
			for (var i = 0, l = colors.length; i < l; ++i) {

				var size = this.stats[i] / this.population;


				if (size > 0) {
					canvas.beginPath();
					canvas.moveTo(22, 22);
					canvas.fillStyle = colors[i];
					var from = start,
							to = start + size * pi2;

					if (to < from) {
						from = start;
					}
					canvas.arc(22,22,22, from, to);

					start = start + size*pi2;
					canvas.lineTo(22,22);
					canvas.fill();
					canvas.closePath();
				}

			}

			canvas.beginPath();
			canvas.fillStyle = "rgba(255, 255, 255, 0)"; // TODO: Ask about this
			var diameter = 13;
			canvas.arc(22, 22, diameter, 0, Math.PI*2);
			canvas.fill();
			canvas.closePath();

			canvas.fillStyle = '#000000';
			canvas.textAlign = 'center';
			canvas.textBaseline = 'middle';
			canvas.font = 'bold 12px sans-serif';

			canvas.fillText(this.population, 22, 22, 40);
		}
	});

	// markers storage for quick adding - deleting
	let traffic_accident_markers = []
	let bike_accident_markers = []
	let pedestrian_accident_markers = []
	let traffic_category = 0
	let bike_category = 1
	let pedestrian_category = 2

	function add_traffic_accidents() {
		if (traffic_accident_markers.length > 0){
			console.log("Registering " + traffic_accident_markers.length + " markers");
			accidents_cluster.RegisterMarkers(traffic_accident_markers);
		} else {
			console.log("Building traffic_accidents_markers anew");
			traffic_accidents.forEach(value => {
				marker = create_cluster_marker(value);
				marker.category = traffic_category;
				traffic_accident_markers.push(marker)
				accidents_cluster.RegisterMarker(marker)}
			);
		}
		accidents_cluster.ProcessView();
	}

	function add_bike_accidents() {
		if (bike_accident_markers.length > 0){
			console.log("Registering " + bike_accident_markers.length + " markers");
			accidents_cluster.RegisterMarkers(bike_accident_markers);
		} else {
			console.log("Building bike_accidents_markers anew");
			bike_accidents.forEach(value => {
				marker = create_cluster_marker(value);
				marker.fillColor = colors[bike_category];
				marker.category = bike_category;
				bike_accident_markers.push(marker);
				accidents_cluster.RegisterMarker(marker)}
			);
		}
	accidents_cluster.ProcessView();
	}

	function add_pedestrian_accidents() {
		if (pedestrian_accident_markers.length > 0) {
			console.log("Registering " + pedestrian_accident_markers.length + " markers");
			accidents_cluster.RegisterMarkers(pedestrian_accident_markers);
		} else {
			console.log("Building pedestrian_accidents_markers anew");
			pedestrian_accidents.forEach(value => {
				marker = create_cluster_marker(value);
				marker.category = pedestrian_category;
				pedestrian_accident_markers.push(marker);
				accidents_cluster.RegisterMarker(marker)}
			);
		}
	accidents_cluster.ProcessView();
	}

	function remove_traffic_accidents() {
		accidents_cluster.RemoveMarkers(traffic_accident_markers);
		accidents_cluster.ProcessView();
	}

	function remove_bike_accidents() {
		accidents_cluster.RemoveMarkers(bike_accident_markers);
		accidents_cluster.ProcessView();
	}

	function remove_pedestrian_accidents() {
		accidents_cluster.RemoveMarkers(pedestrian_accident_markers);
		accidents_cluster.ProcessView();
	}

	public_transportation_stops.forEach(add_public_trans_stops);
	street_lights.forEach(add_street_lights);

	function create_cluster_marker(value) {
		return new PruneCluster.Marker(value.split(",")[0], value.split(",")[1]);
	}

	function add_public_trans_stops(value) {
		var circle = L.circle([value.split(",")[0], value.split(",")[1]], {
		// color: '#800080',
		stroke: false,
		fillColor: '#800080',
		fillOpacity: 0.5,
		radius: 1.5,
	}).addTo(public_transport_stops_layer).bindPopup(value.split(",")[2]);
	}

	function add_street_lights(value) {
		var circle = L.circle([value.split(",")[0], value.split(",")[1]], {
		// color: '#F8D609FF',
		stroke: false,
		fillColor: '#ffac00',
		fillOpacity: 0.5,
		radius: 1.5,
	}).addTo(street_lights_layer);
	}




	accidents.addLayer(accidents_cluster);
	// traffic_accident_layer.addLayer(traffic_accidents_cluster);
	// bike_accident_layer.addLayer(bike_accidents_cluster);
	// pedestrian_accident_layer.addLayer(pedestrian_accidents_cluster);

	var tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 19,
		attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
		});

	var map = L.map('map', {
		center: [49.196822238343486, 16.60474816825514],
		zoom: 13,
		layers: [tiles]
	});

	var base_layers = {"OpenStreetMap": tiles}
	var overlays = {
		"<span id='traffic_accidents'>Traffic accidents</span>": accidents,
		"<span id='bike_accidents'>Bike accidents</span>": accidents,
		"<span id='pedestrian_accidents'>Pedestrian accidents</span>": accidents,
		"Street lights": street_lights_layer
	}
	var layerControl = L.control.layers(base_layers, overlays).addTo(map);


	// create the control
// var command = L.control({position: 'topright'});
//
// command.onAdd = function (map) {
//     var div = L.DomUtil.create('div', 'command');
//
//     div.innerHTML = '<form><input id="command" type="checkbox"/>dopravni nehody</form>';
//     return div;
// };
//
// command.addTo(map);
//
// 	var baseMaps = {
// 		"OpenStreetMaps": tiles,
// 	}
//
// add the event handlers
function toggle_traffic_accidents() {
   if (this.checked) {
	   console.log("Adding traffic accidents");
	   add_traffic_accidents();
   } else {
	   console.log("Removing traffic accidents");
	   remove_traffic_accidents();
   }
}

function toggle_bike_accidents() {
	if (this.checked) {
		console.log("Adding bike accidents");
		add_bike_accidents();
	} else {
		console.log("Removing bike accidents");
		remove_bike_accidents();
	}}

function toggle_pedestrian_accidents() {
	if (this.checked) {
		console.log("Adding pedestrian accidents");
		add_pedestrian_accidents();
	} else {
		console.log("Removing pedestrian accidents");
		remove_pedestrian_accidents();
	}}
//

document.getElementById("traffic_accidents").parentNode.parentNode.firstElementChild.addEventListener ("change", toggle_traffic_accidents, false);
document.getElementById("bike_accidents").parentNode.parentNode.firstElementChild.addEventListener ("change", toggle_bike_accidents, false);
document.getElementById("pedestrian_accidents").parentNode.parentNode.firstElementChild.addEventListener ("change", toggle_pedestrian_accidents, false);









// alert(traffic_accident_marker_list.length);


// var layerControl = L.control.layers(baseMaps, traffic_accident_layer).addTo(map);
//
// layerControl.addOverlay(traffic_accident_layer, "Traffic accidents");

// for (coord in lat_lon) {
// 	L.marker(coord.split(",")).addTo(map)
// }
// <!--	var div = L.DomUtil.create('div', 'info legend');-->
// <!--	div.innerHTML = '<select><option>1</option><option>2</option><option>3</option></select>';-->
// <!--	div.firstChild.onmousedown = div.firstChild.ondblclick = L.DomEvent.stopPropagation;-->
// <!--	return div;-->
//
// <!--	var marker = L.marker([51.5, -0.09]).addTo(map)-->
// <!--		.bindPopup('<b>Hello world!</b><br />I am a popup.').openPopup();-->
//
// <!--	var circle = L.circle([51.508, -0.11], {-->
// <!--		color: 'red',-->
// <!--		fillColor: '#f03',-->
// <!--		fillOpacity: 0.5,-->
// <!--		radius: 500-->
// <!--	}).addTo(map).bindPopup('I am a circle.');-->
//
// <!--	var polygon = L.polygon([-->
// <!--		[51.509, -0.08],-->
// <!--		[51.503, -0.06],-->
// <!--		[51.51, -0.047]-->
// <!--	]).addTo(map).bindPopup('I am a polygon.');-->
//
//
// <!--	var popup = L.popup()-->
// <!--		.setLatLng([49, 16])-->
// <!--		.setContent('I am a standalone popup.')-->
// <!--		.openOn(map);-->
//
// 	function onMapClick(e) {
// 		popup
// 			.setLatLng(e.latlng)
// 			.setContent('You clicked the map at ' + e.latlng.toString())
// 			.openOn(map);
// 	}

	// map.on('click', onMapClick);

</script>



</body>
</html>
