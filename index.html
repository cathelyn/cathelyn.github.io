<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Brno Accident Data Visualization</title>

	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

	<link rel="shortcut icon" type="image/png" href="docs/images/favicon.png" />
	<link rel="stylesheet" href="css/style.css" />
	<link rel="stylesheet" href="leaflet/leaflet.css" />
	<link rel="stylesheet" href="css/LeafletStyleSheet.css" />
	<link rel="stylesheet" href="css/leaflet-sidebar.css" />

	<!--	Leaflet -->
	<script src="leaflet/leaflet.js"></script>
	<!--	Prune clustering-->
	<script src="js/PruneCluster.js"></script>
	<!--	Leaflet sidebar-->
	<script src="js/leaflet-sidebar.js"></script>

	<!--	Data sources TODO: Find better way to store-->

<!--	<script src="sources/bike_accidents_lat_lon_date.js"></script>-->
<!--	<script src="sources/traffic_accidents_date.js"></script>-->
<!--	<script src="sources/ped_accidents_lat_lon_date.js"></script>-->
	<script src="sources/pub_trans_stops_lat_lon_name.js"></script>
	<script src="sources/street_lights_lat_lon_date.js"></script>

</head>
<body>

<div id="sidebar" class="sidebar collapsed">
	<!-- Nav tabs -->
	<div class="sidebar-tabs">
		<ul role="tablist">
			<li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
			<li class="disabled"><a href="#profile" role="tab"><i class="fa fa-user"></i></a></li>
			<li ><a href="#filters" role="tab"><i class="fa fa-filter"></i></a></li>
		</ul>

		<ul role="tablist">
			<li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
		</ul>
	</div>

	<!-- Tab panes -->
	<div class="sidebar-content">
		<div class="sidebar-pane" id="home">
			<h1 class="sidebar-header">
				Brno accident data visualization
				<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
			</h1>
			<!--			TODO: Decide what to do with this menu -->
			This is a project.

		</div>

		<div class="sidebar-pane" id="profile">
			<h1 class="sidebar-header">Profile<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
		</div>

		<div class="sidebar-pane" id="filters">
			<h1 class="sidebar-header">Filters<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
		</div>

		<div class="sidebar-pane" id="settings">
			<h1 class="sidebar-header">Settings<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
		</div>
	</div>
</div>


<!--TODO: Use marker.filtered instead of removing markers from accident cluster -->

<div id="map" class="sidebar-map" style="width: 100vw; height: 100vh;"></div>

<script type="module">
	// CONSTANTS
	const categories_colors = ['rgba(255,75,0,0.6)', 'rgba(160,61,229,0.6)', 'rgba(3,170,234,0.6)'];
	const pi2 = Math.PI * 2;
	// categories configuration
	const traffic_category = 0
	const bike_category = 1
	const pedestrian_category = 2
	// END CONSTANTS

	// DATA
	// ["sources/bike_accidents.js", "sources/bike_accidents.js", "sources/bike_accidents.js'"]
	import {bike_accidents_json} from "./sources/bike_accidents.js";
	import {traffic_accidents_json} from "./sources/traffic_accidents.js";
	import {pedestrian_accidents_json} from "./sources/ped_accidents.js";
	// START LAYER SETUP
	// one main layer group
	let accidents = L.layerGroup();
	// main clustering layer
	let accidents_cluster = new PruneClusterForLeaflet(160);


	// other info layers
	let pedestrian_crossings_layer = L.layerGroup();
	let public_transport_stops_layer = L.layerGroup();
	let street_lights_layer = L.layerGroup();
	let street_slopes_layer = L.layerGroup();
	// END LAYER SETUP

	// START ICON (MARKER) GENERATOR
	// icons for separate categories
	accidents_cluster.BuildLeafletClusterIcon = function(cluster) {
		let e = new L.Icon.MarkerCluster();

		e.stats = cluster.stats;
		e.population = cluster.population;
		return e;
	};

	L.Icon.MarkerCluster = L.Icon.extend({
		options: {
			iconSize: new L.Point(44, 44),
			className: 'prunecluster leaflet-markercluster-icon'
		},

		createIcon: function () {
			// based on L.Icon.Canvas from shramov/leaflet-plugins (BSD licence)
			let e = document.createElement('canvas');
			this._setIconStyles(e, 'icon');
			let s = this.options.iconSize;
			e.width = s.x;
			e.height = s.y;
			this.draw(e.getContext('2d'), s.x, s.y);
			return e;
		},

		createShadow: function () {
			return null;
		},

		draw: function(canvas) {
			let start = 0;
			for (let i = 0, l = categories_colors.length; i < l; ++i) {

				let size = this.stats[i] / this.population;


				if (size > 0) {
					canvas.beginPath();
					canvas.moveTo(22, 22);
					canvas.fillStyle = categories_colors[i];
					let from = start,
							to = start + size * pi2;

					if (to < from) {
						from = start;
					}
					canvas.arc(22,22,22, from, to);

					start = start + size*pi2;
					canvas.lineTo(22,22);
					canvas.fill();
					canvas.closePath();
				}

			}

			canvas.beginPath();
			canvas.fillStyle = "rgba(255, 255, 255, 0)"; // TODO: Ask about this
			let diameter = 13;
			canvas.arc(22, 22, diameter, 0, Math.PI*2);
			canvas.fill();
			canvas.closePath();

			canvas.fillStyle = '#000000';
			canvas.textAlign = 'center';
			canvas.textBaseline = 'middle';
			canvas.font = 'bold 12px sans-serif';

			canvas.fillText(this.population, 22, 22, 40);
		}
	});

	function fontAwesomeMapMarkerIcon()
	{
		return new L.divIcon({
					html: '<i class="fa fa-map-marker fa-2x"></i>',
					iconSize: [40, 40],
					className: "MapMarkerIcon",
				}
		)
	}

	// END ICON (MARKER) GENERATOR

	// START MARKER GENERATOR FROM DATA

	// markers storage for quick adding - deleting
	let traffic_accident_markers = []
	let bike_accident_markers = []
	let pedestrian_accident_markers = []

	function add_accident(dataset, markers_array, category)
	/**
	 * Create and add markers for the accidents based on the date in @param dataset. Created markers are also stored
	 * in @param markers_array for further manipulation and filtering. Each marker is assigned a respective category.
	 * @param dataset input data in js array format consisting of comma-separated lat,lon,YYYY,MM,DD values
	 * @param markers_array js array for storing created markers
	 * @param category representation of category for filtering/icon composition purposes
	 */
	{
		if (markers_array.length > 0){
			console.log("Registering " + markers_array.length + " markers");
			markers_array.map(marker => {marker.filtered = false})
		} else {

			let colour_class = "black";
			if (category === 0) {
				colour_class = "red";
			}
			else if (category === 1) {
				colour_class = "violet";
			}
			else if (category === 2) {
				colour_class = "blue";
			}


			console.log("Building markers anew");
			dataset.forEach(value => {
				let marker = create_cluster_marker(value);
				marker.date = create_date_from_YYYY_MM_DD(value);
				marker.filtered = true;
				marker.category = category;

				marker.data.icon = fontAwesomeMapMarkerIcon();
				marker.data.icon.options.className = "MapMarkerIcon " + colour_class;

				marker.data.popup = "<b>" + value.point_y + value.point_x + "</b>"; // TODO: make popup
				markers_array.push(marker);
				accidents_cluster.RegisterMarker(marker)}
			);
		}
		accidents_cluster.ProcessView();
	}

	function add_traffic_accidents() {
		add_accident(traffic_accidents_json, traffic_accident_markers, traffic_category);
	}

	function add_bike_accidents() {
		add_accident(bike_accidents_json, bike_accident_markers, bike_category);
	}

	function add_pedestrian_accidents() {
		add_accident(pedestrian_accidents_json, pedestrian_accident_markers, pedestrian_category);
	}

	function remove_marker_set(marker_set) {
		marker_set.map(marker => {marker.filtered = true})
		accidents_cluster.ProcessView();
	}

	// init the clusters
	add_traffic_accidents();
	add_bike_accidents();
	add_pedestrian_accidents();

	public_transportation_stops.forEach(add_public_trans_stops);
	street_lights.forEach(add_street_lights);

	function create_cluster_marker(value) {
		return new PruneCluster.Marker(
				value.point_y,
				value.point_x
		)
	}

	function create_date_from_YYYY_MM_DD(value) {
		return new Date(value.year
				+ "-" + value.month.toString().padStart(2, '0')
				+ "-" + value.day.toString().padStart(2, '0')
				+ "T00:00:00.000Z");
	}

	function add_public_trans_stops(value) {
		L.circle([value.split(",")[0], value.split(",")[1]], {
			stroke: false,
			fillColor: '#800080',
			fillOpacity: 0.5,
			radius: 1.5,
		}).addTo(public_transport_stops_layer).bindPopup(value.split(",")[2]);
	}

	function add_street_lights(value) {
		// TODO: Make this faster (probably run in the bg on startup or use CircleMarker)
		L.circle([value.split(",")[0], value.split(",")[1]], {
			stroke: false,
			fillColor: '#ffac00',
			fillOpacity: 0.5,
			radius: 1.5,
		}).addTo(street_lights_layer);
	}

	accidents.addLayer(accidents_cluster);


	let OSM = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 19,
		attribution: 'Katarína Bulková<br>&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
	});

	var CartoDB_Positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
		attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
		subdomains: 'abcd',
		maxZoom: 20
	});

	let map = L.map('map', {
		center: [49.196822238343486, 16.60474816825514],
		zoom: 13,
		zoomControl: false,
		layers: [OSM]
	});

	const base_layers = {
		"OpenStreetMap": OSM,
		"Carto": CartoDB_Positron}
	const overlays = {
		"<span id='traffic_accidents'><i class='fa fa-map-marker red'></i> Traffic accidents</span>": accidents,
		"<span id='bike_accidents'><i class='fa fa-map-marker violet'></i> Bike accidents</span>": accidents,
		"<span id='pedestrian_accidents'><i class='fa fa-map-marker blue'></i> Pedestrian accidents</span>": accidents,
		"Street lights": street_lights_layer,
		"<i class='fa fa-bus'></i> Bus Stops": public_transport_stops_layer,

	}

	// layer selector
	L.control.layers(base_layers, overlays).addTo(map);

	// zoom control
	L.control.zoom({
		position: 'bottomright'
	}).addTo(map)

	// sidebar
	L.control.sidebar('sidebar').addTo(map);



	// add the event handlers
	function toggle_traffic_accidents() {
		if (this.checked) {
			console.log("Adding traffic accidents");
			add_traffic_accidents();
		} else {
			console.log("Removing traffic accidents");
			remove_marker_set(traffic_accident_markers);
		}
	}

	function toggle_bike_accidents() {
		if (this.checked) {
			console.log("Adding bike accidents");
			add_bike_accidents();
		} else {
			console.log("Removing bike accidents");
			remove_marker_set(bike_accident_markers);
		}}

	function toggle_pedestrian_accidents() {
		if (this.checked) {
			console.log("Adding pedestrian accidents");
			add_pedestrian_accidents();
		} else {
			console.log("Removing pedestrian accidents");
			remove_marker_set(pedestrian_accident_markers);
		}}

	document.getElementById("traffic_accidents").parentNode.parentNode.firstElementChild.addEventListener ("change", toggle_traffic_accidents, false);
	document.getElementById("bike_accidents").parentNode.parentNode.firstElementChild.addEventListener ("change", toggle_bike_accidents, false);
	document.getElementById("pedestrian_accidents").parentNode.parentNode.firstElementChild.addEventListener ("change", toggle_pedestrian_accidents, false);

</script>
</body>
</html>
