<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Brno Accident Data Visualization</title>


	<link rel="shortcut icon" type="image/png" href="docs/images/favicon.png" />
	<link rel="stylesheet" href="css/style.css" />
	<link rel="stylesheet" href="leaflet/leaflet.css" />
	<link rel="stylesheet" href="css/LeafletStyleSheet.css" />
	<link rel="stylesheet" href="css/leaflet-sidebar.css" />
	<!--	<link rel="stylesheet" href="css/leaflet-tag-filter-button.css" />-->
	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.css" integrity="sha512-SZgE3m1he0aEF3tIxxnz/3mXu/u/wlMNxQSnE0Cni9j/O8Gs+TjM9tm1NX34nRQ7GiLwUEzwuE3Wv2FLz2667w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css" integrity="sha512-3q8fi8M0VS+X/3n64Ndpp6Bit7oXSiyCnzmlx6IDBLGlY5euFySyJ46RUlqIVs0DPCGOypqP8IRk/EyPvU28mQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" type="text/css" href="scss/custom.css" />

	<!-- FontAwesome-->
	<script src="https://kit.fontawesome.com/1f4d66b7c3.js" crossorigin="anonymous"></script>

	<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>


	<!--	Leaflet -->
	<script src="leaflet/leaflet.js"></script>
	<!--	Prune clustering-->
	<script src="js/PruneCluster.js"></script>
	<!--	Leaflet sidebar-->
	<script src="js/leaflet-sidebar.js"></script>
	<!--	Filtering -->
	<!--	<script src="js/leaflet-easy-button.js"></script>-->
	<!--	<script src="js/leaflet-tag-filter-button.js"></script>-->
	<!--	Leaflet Shapefile	-->
	<script src="js/leaflet.shpfile.js"></script>
	<script src="js/shp.js"></script>
	<script src="js/catiline.js"></script>
	<!--	Bootstrap -->
	<script src="bootstrap/dist/js/bootstrap.js"></script>
	<!--	Bootstrap slider plugin -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.min.js" integrity="sha512-f0VlzJbcEB6KiW8ZVtL+5HWPDyW1+nJEjguZ5IVnSQkvZbwBt2RfCBY0CBO1PsMAqxxrG4Di6TfsCPP3ZRwKpA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.js" integrity="sha512-tCkLWlSXiiMsUaDl5+8bqwpGXXh0zZsgzX6pB9IQCZH+8iwXRYfcCpdxl/owoM6U4ap7QZDW4kw7djQUiQ4G2A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<!--	Custom functions	-->
	<script src="js/filtering.js"></script>
	<script src="js/utilities.js"></script>
	<script src="js/event-handlers.js"></script>
	<script src="js/date-selectors.js"></script>
	<script src="js/main-layer-builders.js"></script>
	<script src="js/extra-layer-builders.js"></script>
	<!--	Constants -->
	<script src="js/base-maps.js"></script>


	<!--	Data sources-->

	<script src="sources/bike_accidents.js"></script>
	<script src="sources/traffic_accidents.js"></script>
	<script src="sources/ped_accidents.js"></script>
	<script src="sources/pub_trans_stops_lat_lon_name.js"></script>
	<script src="sources/street_lights_lat_lon_date.js"></script>

</head>
<body>

<!-- SIDEBAR -->
<div id="sidebar" class="sidebar collapsed">
	<!-- Nav tabs -->
	<div class="sidebar-tabs">
		<ul role="tablist">
			<li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
			<li ><a href="#layers" role="tab"><i class="fa-solid fa-layer-group"></i></a></li>
			<li><a href="#dates" role="tab"><i class="fa-solid fa-calendar-days"></i></a></li>
			<li ><a href="#filter" role="tab"><i class="fa-solid fa-filter"></i></a></li>
		</ul>
	</div>

	<!-- Tab panes -->
	<div class="sidebar-content">
		<div class="sidebar-pane" id="home">
			<h1 class="sidebar-header">
				BRNO ACCIDENT DATA VISUALIZATION
				<span class="sidebar-close"><i class="fa-solid fa-angle-left"></i></span>
			</h1>
			<hr>
			<div>
				<p class="text-light">Map visualizes various kinds of accidents that happened in Brno. It is possible to turn on and off traffic, pedestrian and bike accidents in the layers section. Except of that, it is possible to select various architectural surroundings of the traffic lanes, cycling infrastructure and street slopes. In the date section it is possible to select accidents according to date, date range or just choose custom date, and in the filter section it is possible to select accidents according to various criteria. The selection is visualized by aggregation into the clusters, if there are more accidents in the same locations. </p>
			</div>

		</div>

		<div class="sidebar-pane" id="layers">
			<h1 class="sidebar-header">LAYERS SELECTION<span class="sidebar-close"><i class="fa-solid fa-angle-left"></i></span>
			</h1>
			<script>
				function toggleGroupOnManualSelection() {
					let checkbox = this.parentNode.parentNode.firstElementChild;
					if (Array.from(this.parentNode.children).every(el => el.classList.contains('enabled'))) {
						checkbox.checked = true;
					} else {
						checkbox.checked = false;
					}

				}

				function generateOverlaysControl() {
					let outputEl = document.getElementById("layer_selector");
					const ulMain = document.createElement('ul');

					Object.keys(overlaysGrouped).forEach(group => {

						let dividerHr = document.createElement('hr');
						dividerHr.classList.add("catDivider");
						ulMain.appendChild(dividerHr);

						const liGroup = document.createElement('li');
						liGroup.classList.add('overlayGroup');
						liGroup.classList.add('form-check');
						liGroup.classList.add('form-switch');
						liGroup.classList.add('bg-transparent');
						liGroup.classList.add('mb-3');
						// liGroup.innerHTML = group;

						const checkbox = document.createElement('input');
						checkbox.classList.add("form-check-input")
						checkbox.type = "checkbox";
						checkbox.name = group;
						checkbox.id = "chb_" + group.replace(" ", "_");

						// label for the checkbox
						const groupLabel = document.createElement('label');
						groupLabel.classList.add('form-check-label');
						groupLabel.classList.add('ms-2');
						groupLabel.classList.add('text-uppercase');
						groupLabel.classList.add('text-light');
						groupLabel.classList.add('mb-2');
						groupLabel.htmlFor = "chb_" + group.replace(" ", "_");

						// label tag
						groupLabel.appendChild(document.createTextNode(group));

						liGroup.appendChild(checkbox);
						liGroup.appendChild(groupLabel)


						checkbox.addEventListener("change", function () {
							const trigger = new Event("change");
							const groupItems = this.parentElement.getElementsByTagName('li');
							for (const item of groupItems) {
								if (this.checked){
									if (!item.classList.contains("enabled"))
										item.dispatchEvent(trigger);
								} else {
									if (item.classList.contains("enabled")){
										item.dispatchEvent(trigger);
									}
								}
							}
						})



						ulMain.appendChild(liGroup)
						const ulNestedGroup = document.createElement('ul');
						ulNestedGroup.classList.add('ps-1');
						liGroup.appendChild(ulNestedGroup);
						Object.keys(overlaysGrouped[group]).forEach((layerName, index) => {
							const liLayer = document.createElement('li');
							liLayer.classList.add('overlayLayer');
							liLayer.classList.add('mb-2');
							liLayer.classList.add('px-2');
							liLayer.classList.add('layer-item');
							liLayer.innerHTML = layerName;
							let colorBadge = document.createElement("span");
							colorBadge.classList.add("badge");
							colorBadge.classList.add("float-end");
							colorBadge.innerHTML = "";
							liLayer.appendChild(colorBadge);
							["click", "change"].forEach(event => liLayer.addEventListener(event, function() {
								if (layerName.toString().includes("Traffic accidents")) {
											toggleTrafficAccidents(this);
											return;
										} else if (layerName.toString().includes("Bike accidents")){
											toggleBikeAccidents(this);
											return;
										} else if (layerName.toString().includes("Pedestrian accidents")) {
											togglePedestrianAccidents(this);
											return;
										}
										if (!this.classList.contains("enabled")) {
											this.classList.add("enabled");
											if (group.toString().includes("Cycling")) {
												colorBadge.innerText = "■";
												colorBadge.style.color = cyclingInfraColors[index];
											}
											if (group.toString().includes("slopes")) {
												colorBadge.innerText = "■";
												colorBadge.style.color = streetSlopesColors[3 - index];
											}
											map.addLayer(overlaysGrouped[group][layerName]);
										} else if (this.classList.contains("enabled")) {
											this.classList.remove("enabled")
											colorBadge.innerHTML = "";
											map.removeLayer(overlaysGrouped[group][layerName]);
										}
									})
							);
							liLayer.addEventListener("click", toggleGroupOnManualSelection);
							ulNestedGroup.appendChild(liLayer);
						})
					})
					outputEl.appendChild(ulMain);
				}

			</script>
			<div id="layer_selector">

			</div>

		</div>

		<div class="sidebar-pane" id="dates">
			<h1 class="sidebar-header">DATE SELECTOR<span class="sidebar-close"><i class="fa-solid fa-angle-left"></i></span></h1>
			<hr>
			<script>
				function activate_date_selector() {
					let range_selector = document.getElementById('date_range_selector').checked;
					if (range_selector) {
						document.getElementById('custom_date_selector_form').classList.add("collapse");
						document.getElementById('date_range_selector_form').classList.remove("collapse");
					} else {
						document.getElementById('custom_date_selector_form').classList.remove("collapse");
						document.getElementById('date_range_selector_form').classList.add("collapse");
					}
				}
			</script>
			<div class="d-grid gap-2 my-3">
				<input type="radio" class="btn-check " name="options-outlined" id="date_range_selector" autocomplete="off" onclick="activate_date_selector()" checked>
				<label class="btn btn-outline-secondary " for="date_range_selector">Date range</label>
			</div>

			<div id="date_range_selector_form" class="collapse">
				<input id="date_range" type="text" name="dates" class=col-12 aria-label="Date Range selector"/>
				<script>
					$('input[name="dates"]').daterangepicker({
								opens: 'right',
								startDate: "01/01/2010",
								endDate: "12/31/2021",
								showDropdowns: true,
								minYear: 2010,
								maxYear: 2021,
							},
							function(start, end, label) {
								DateRangeFilter(start, end);
							}
					);
				</script>
			</div>
			<hr>
			<div class="d-grid gap-2 col-5 my-3">
				<input type="radio" class="btn-check" name="options-outlined" id="custom_date_selector" onclick="activate_date_selector()" autocomplete="off" >
				<label class="btn btn-outline-secondary" for="custom_date_selector">Custom date</label>
			</div>

			<div id="custom_date_selector_form" class="collapse" >
				<div class="input-group row-container">
					<div class="input-group-text col-lg-1">
						<input type="checkbox" name="fields" aria-label="Checkbox for selecting Year filter">
					</div>
					<span class="input-group-text col-lg-5">Year</span>
					<select class="form-select form-control col-lg-6" multiple id="year" aria-label="Year selector">
						<option value=2010>2010</option>
						<option value=2011>2011</option>
						<option value=2012>2012</option>
						<option value=2013>2013</option>
						<option value=2014>2014</option>
						<option value=2015>2015</option>
						<option value=2016>2016</option>
						<option value=2017>2017</option>
						<option value=2018>2018</option>
						<option value=2019>2019</option>
						<option value=2020>2020</option>
						<option value=2021>2021</option>
					</select>
				</div>
				<div class="input-group row-container">
					<div class="input-group-text col-lg-1">
						<input type="checkbox" name="fields" aria-label="Checkbox for selecting Month filter">
					</div>
					<span class="input-group-text col-lg-5">Month</span>

					<select class="form-select form-control col-lg-6" multiple id="month">
						<option value=0>January</option>
						<option value=1>February</option>
						<option value=2>March</option>
						<option value=3>April</option>
						<option value=4>May</option>
						<option value=5>June</option>
						<option value=6>July</option>
						<option value=7>August</option>
						<option value=8>September</option>
						<option value=9>October</option>
						<option value=10>November</option>
						<option value=11>December</option>
					</select>
				</div>

				<div class="input-group row-container">
					<div class="input-group-text col-lg-1">
						<input type="checkbox" name="fields" aria-label="Checkbox for selecting Day filter">
					</div>
					<span class="input-group-text col-lg-5">Day</span>

					<select class="form-select form-control col-lg-6" multiple id="day" >
						<option value=1>1</option>
						<option value=2>2</option>
						<option value=3>3</option>
						<option value=4>4</option>
						<option value=5>5</option>
						<option value=6>6</option>
						<option value=7>7</option>
						<option value=8>8</option>
						<option value=9>9</option>
						<option value=10>10</option>
						<option value=11>11</option>
						<option value=12>12</option>
						<option value=13>13</option>
						<option value=14>14</option>
						<option value=15>15</option>
						<option value=16>16</option>
						<option value=17>17</option>
						<option value=18>18</option>
						<option value=19>19</option>
						<option value=20>20</option>
						<option value=21>21</option>
						<option value=22>22</option>
						<option value=23>23</option>
						<option value=24>24</option>
						<option value=25>25</option>
						<option value=26>26</option>
						<option value=27>27</option>
						<option value=28>28</option>
						<option value=29>29</option>
						<option value=30>30</option>
						<option value=31>31</option>
					</select>
				</div>
				<div class="input-group row-container">
					<div class="input-group-text col-lg-1">
						<input type="checkbox" name="fields" aria-label="Checkbox for selecting Day of the week filter">
					</div>
					<span class="input-group-text col-lg-5">Day of the week</span>

					<select class="form-select col-lg-6" multiple id="weekday">
						<option value=1>Monday</option>
						<option value=2>Tuesday</option>
						<option value=3>Wednesday</option>
						<option value=4>Thursday</option>
						<option value=5>Friday</option>
						<option value=6>Saturday</option>
						<option value=7>Sunday</option>
					</select>
				</div>
				<div class="input-group row-container">
					<div class="input-group-text col-lg-1">
						<input type="checkbox" name="fields" aria-label="Checkbox for selecting Time of the day filter">
					</div>
					<span class="input-group-text col-lg-5">Day / Night</span>

					<select class="form-select col-lg-6" multiple id="daynight">
						<option value="Day">Day</option>
						<option value="Night">Night</option>
					</select>
				</div>
				<div>
					<button type="submit" class="btn btn-outline-primary" onclick="DateCustomSelect()">Filter</button>
				</div>
			</div>
		</div>


		<div class="sidebar-pane" id="filter">
			<h1 class="sidebar-header">FILTERS<span class="sidebar-close"><i class="fa-solid fa-angle-left"></i></span></h1>
			<div id="filters">

			</div>

		</div>

	</div>
</div>


<div id="map" class="sidebar-map" style="width: 100vw; height: 100vh;"></div>

<script>
	// CONSTANTS
	// const categoriesColors = ['rgba(187,32,138,0.8)', 'rgba(255,193,25,0.8)', 'rgba(3,170,234,0.8)'];
	const categoriesColors = [
		getComputedStyle(document.documentElement).getPropertyValue('--violet'),
		getComputedStyle(document.documentElement).getPropertyValue('--green'),
		getComputedStyle(document.documentElement).getPropertyValue('--blue')
	];
	const pi2 = Math.PI * 2;

	// categories configuration
	const trafficCategory = 0
	const bikeCategory = 1
	const pedestrianCategory = 2
	// END CONSTANTS

	// START LAYER SETUP
	// main clustering layer
	let accidentsCluster = new PruneClusterForLeaflet(160);

	// other info layers
	let pedestrianCrossingsLayer = L.layerGroup();
	let publicTransportStopsLayer = L.layerGroup();
	let streetLightsLayer = L.layerGroup();

	// cycling infrastructure
	let cyclingInfraSourceFiles = {
		'BicycleCrossing.shp.zip': L.layerGroup(),
		'BikePath.shp.zip': L.layerGroup(),
		'BikePathInTheOppositeDirection(Lane).shp.zip': L.layerGroup(),
		'CyclistsRidingInTheOppositeDirection.shp.zip': L.layerGroup(),
		'DedicatedBicycleLane.shp.zip': L.layerGroup(),
		'EntryAllowedForCyclists.shp.zip': L.layerGroup(),
		'MarkedCorridorForCyclists.shp.zip': L.layerGroup(),
		'NoEntryForAllMotorVehicles.shp.zip': L.layerGroup(),
		'Others.shp.zip': L.layerGroup(),
		'PathForPedestriansAndCyclists(Separated).shp.zip': L.layerGroup(),
		'PathForPedestriansAndCyclists(Unseparated).shp.zip': L.layerGroup(),
		'PedestrianPathWithCyclistsAllowed.shp.zip': L.layerGroup(),
		'ProhibitedEntryForCyclists.shp.zip': L.layerGroup(),
		'ProtectiveLaneForCyclists.shp.zip': L.layerGroup(),
		'ReservedLaneForTaxi_Bicycle_Bus.shp.zip': L.layerGroup(),
		'TheSectionWasCanceled.shp.zip': L.layerGroup()
	}

	// street slopes
	let streetSlopeSourceFiles = {
		'Extreme.shp.zip': L.layerGroup(),
		'Dangerous.shp.zip': L.layerGroup(),
		'Medium.shp.zip': L.layerGroup(),
		'Min.shp.zip': L.layerGroup()
	}

	const overlaysGrouped = {
		"Accidents" : {
			"<span id='traffic_accidents'><i class='fa fa-map-marker fa-fw color_cat_0'></i> Traffic accidents</span>": accidentsCluster,
			"<span id='bike_accidents'><i class='fa fa-map-marker fa-fw color_cat_1'></i> Bike accidents</span>": accidentsCluster,
			"<span id='pedestrian_accidents'><i class='fa fa-map-marker fa-fw color_cat_2'></i> Pedestrian accidents</span>": accidentsCluster,
		}, "Architecture": {
			"<i class='fa-regular fa-lightbulb fa-fw'></i> Street lights": streetLightsLayer,
			"<i class='fa-solid fa-bus fa-fw'></i> Public Transport Stops": publicTransportStopsLayer,
			"<i class='fa-solid fa-person-walking fa-fw'></i> Pedestrian Crossings": pedestrianCrossingsLayer,
		}, "Cycling infrastrucure": {
			"<i class='fa-solid fa-bicycle fa-fw'></i> Bicycle Crossing": cyclingInfraSourceFiles["BicycleCrossing.shp.zip"],
			"<i class='fa-solid fa-bicycle fa-fw'></i> Bicycle Path": cyclingInfraSourceFiles["BikePath.shp.zip"],
			"<i class='fa-solid fa-bicycle fa-fw'></i> Separate Line for Taxi, Bicycle, Bus": cyclingInfraSourceFiles["ReservedLaneForTaxi_Bicycle_Bus.shp.zip"],
			"<i class='fa-solid fa-bicycle fa-fw'></i> Bicycle Path in the Opposite direction (Lane)": cyclingInfraSourceFiles["BikePathInTheOppositeDirection(Lane).shp.zip"],
			"<i class='fa-solid fa-bicycle fa-fw'></i> Cyclists riding in the opposite direction": cyclingInfraSourceFiles["CyclistsRidingInTheOppositeDirection.shp.zip"],
			"<i class='fa-solid fa-bicycle fa-fw'></i> Dedicated bicycle line": cyclingInfraSourceFiles["DedicatedBicycleLane.shp.zip"],
			"<i class='fa-solid fa-bicycle fa-fw'></i> Protective Line for Cyclists": cyclingInfraSourceFiles["ProtectiveLaneForCyclists.shp.zip"],
			"<i class='fa-solid fa-bicycle fa-fw'></i> Marked Corridor for Cyclists": cyclingInfraSourceFiles["MarkedCorridorForCyclists.shp.zip"],
			"<i class='fa-solid fa-bicycle fa-fw'></i> Entry Allowed for Cyclists": cyclingInfraSourceFiles["EntryAllowedForCyclists.shp.zip"],
			"<i class='fa-solid fa-bicycle fa-fw'></i> No Entry for All Motor Vehicles": cyclingInfraSourceFiles["NoEntryForAllMotorVehicles.shp.zip"],
			"<i class='fa-solid fa-bicycle fa-fw'></i> Path for Pedestrians and Cyclists (Separated)": cyclingInfraSourceFiles["PathForPedestriansAndCyclists(Separated).shp.zip"],
			"<i class='fa-solid fa-bicycle fa-fw'></i> Path for Pedestrians and Cyclists (Joint)": cyclingInfraSourceFiles["PathForPedestriansAndCyclists(Unseparated).shp.zip"],
			"<i class='fa-solid fa-bicycle fa-fw'></i> Pedestrian Path with Cyclists Allowed": cyclingInfraSourceFiles["PedestrianPathWithCyclistsAllowed.shp.zip"],
			"<i class='fa-solid fa-bicycle fa-fw'></i> Prohibited Entry for Cyclists": cyclingInfraSourceFiles["ProhibitedEntryForCyclists.shp.zip"],
			"<i class='fa-solid fa-bicycle fa-fw'></i> Canceled sections": cyclingInfraSourceFiles["TheSectionWasCanceled.shp.zip"],
			"<i class='fa-solid fa-bicycle fa-fw'></i> Others": cyclingInfraSourceFiles["Others.shp.zip"],
		}, "Street slopes": {
			"<i class='fa-solid fa-arrow-up-right-dots  fa-fw'></i> Minimal (<5%)": streetSlopeSourceFiles["Min.shp.zip"],
			"<i class='fa-solid fa-arrow-up-right-dots fa-fw'></i> Medium (5%-10%)": streetSlopeSourceFiles["Medium.shp.zip"],
			"<i class='fa-solid fa-arrow-up-right-dots fa-fw'></i> Dangerous (10%-20%)": streetSlopeSourceFiles["Dangerous.shp.zip"],
			"<i class='fa-solid fa-arrow-up-right-dots fa-fw'></i> Extreme (>20%)": streetSlopeSourceFiles["Extreme.shp.zip"]
		}
	}
	// END LAYER SETUP

	// START ICON (MARKER) GENERATOR
	// icons for separate categories
	accidentsCluster.BuildLeafletClusterIcon = function(cluster) {
		let e = new L.Icon.MarkerCluster();

		e.stats = cluster.stats;
		e.population = cluster.population;
		return e;
	};

	L.Icon.MarkerCluster = L.Icon.extend({
		options: {
			iconSize: new L.Point(44, 44),
			className: 'prunecluster leaflet-markercluster-icon'
		},

		createIcon: function () {
			// based on L.Icon.Canvas from shramov/leaflet-plugins (BSD licence)
			let e = document.createElement('canvas');
			this._setIconStyles(e, 'icon');
			let s = this.options.iconSize;
			e.width = s.x;
			e.height = s.y;
			this.draw(e.getContext('2d'), s.x, s.y);
			return e;
		},

		createShadow: function () {
			return null;
		},

		draw: function(canvas) {
			let start = 0;
			for (let i = 0, l = categoriesColors.length; i < l; ++i) {

				let size = this.stats[i] / this.population;


				if (size > 0) {
					canvas.beginPath();
					canvas.moveTo(22, 22);
					canvas.fillStyle = categoriesColors[i];
					let from = start,
							to = start + size * pi2;

					if (to < from) {
						from = start;
					}
					canvas.arc(22,22,22, from, to);

					start = start + size*pi2;
					canvas.lineTo(22,22);
					canvas.fill();
					canvas.closePath();
				}

			}

			canvas.beginPath();
			canvas.fillStyle = "rgba(255, 255, 255, 0)"; // TODO: Ask about this
			let diameter = 13;
			canvas.arc(22, 22, diameter, 0, Math.PI*2);
			canvas.fill();
			canvas.closePath();

			canvas.fillStyle = '#000000';
			canvas.textAlign = 'center';
			canvas.textBaseline = 'middle';
			canvas.font = 'bold 12px sans-serif';

			canvas.fillText(this.population, 22, 22, 40);
		}
	});

	// END ICON (MARKER) GENERATOR

	// START MARKER GENERATOR FROM DATA

	// markers storage for quick adding - deleting
	let trafficAccidentMarkers = [];
	let bikeAccidentMarkers = [];
	let pedestrianAccidentMarkers = [];

	// init the clusters
	addTrafficAccidents();
	addBikeAccidents();
	addPedestrianAccidents();

	// build extra information layers
	public_transportation_stops.forEach(addPublicTransStops);
	street_lights.forEach(addStreetLights);
	addBikeInfrastructure();
	addStreetSlopes();
	addPedestrianCrossings();

	let map = L.map('map', {
		center: [49.196822238343486, 16.60474816825514],
		zoom: 13,
		zoomControl: false,
		preferCanvas: true,
		layers: [CartoDB_Positron]
	});

	// clustering layer uses per-marker toggling, can be added directly
	map.addLayer(accidentsCluster);

	const baseLayers = {
		"Carto": CartoDB_Positron,
		"OpenStreetMap": OSM,
		"Stamen TonerLite": Stamen_TonerLite,
		"Cyclo OpenStreetMap": CyclOSM}

	generateOverlaysControl();

	// layer selector
	L.control.layers(baseLayers, [], {groupCheckboxes: true}).addTo(map);

	// zoom control
	L.control.zoom({
		position: 'bottomright'
	}).addTo(map)

	// sidebar
	L.control.sidebar('sidebar').addTo(map);

	// let filterCategories = []

	const filterCategories =  {
		'<i class="fa-solid fa-car fa-fw me-2"></i> Collision With': [
			'crash',
			'collision with a pedestrian',
			'collision with an animal',
			'collision with a moving non-rail vehicle',
			'collision with a fixed obstacle',
			'collision with tram',
			'collision with train',
			'collision with parked vehicle',
			'other'
		],
		'<i class="fa-solid fa-circle-question fa-fw me-2"></i> Cause': [
			'improper driving style',
			'others',
			'speed adjustment',
			'violation of traffic signs or rules',
			'giving way',
			'overtaking',
			'technical defects'
		],
		'<i class="fa-solid fa-person fa-fw me-2"></i> Person': [
			'pedestrian',
			'other passengers (even in the sidecar of the motorcycle)',
			'a passenger in the front seat next to the driver or a passenger (passenger) on a motorcycle, bicycle',
			'passenger in the back seat',
			'unknown',
			'driver'
		],
		'<i class="fa-solid fa-person-half-dress fa-fw me-2"></i> Sex': [
			'man',
			'woman',
			'boy (up to 15 yo)',
			'girl (up to 15 yo)',
			'unknown'
		],
		'<i class="fa-solid fa-image-portrait fa-fw me-2"></i> Age Group': [
			'0-6',
			'7-11',
			'12-15',
			'16-18',
			'19-24',
			'25-32',
			'33-44',
			'45-60',
			'61-70',
			'71+',
			'unknown'
		],
		'<i class="fa fa-beer fa-fw me-2"></i> Alcohol': [
			'DUI - blood alcohol content < 0,24‰',
			'DUI - blood alcohol content < 0,5‰ & >= 0,24‰',
			'DUI - blood alcohol content < 0,8‰ & >= 0,5‰',
			'DUI - blood alcohol content < 1,0‰ & >= 0,8‰',
			'DUI - blood alcohol content < 1,5‰ & >= 1,0‰',
			'DUI - blood alcohol content >= 1,5‰ ',
			'No',
			'not tested',
			'DUI - alcohol and drugs',
			'DUI - drugs'
		],
		'<i class="fa-solid fa-person-circle-question fa-fw me-2"></i> Caused By': [
			'pedestrian',
			'other',
			'another road user',
			'forest or domestic animal',
			'vehicle technical defect',
			'communication obstacle',
			'motor vehicle driver',
			'driver of a non-motor vehicle'
		],
		'<i class="fa-solid fa-person-cane fa-fw me-2"></i> Person Condition': [
			'good - no adverse circumstances were detected',
			'physical indisposition (illness, nausea, reduced mobility, etc.)',
			'invalid',
			'others',
			'illness, injury, etc.',
			'inattention, distractibility',
			'unknown',
			'under the influence of alcohol, blood alcohol content of 1 ‰ or more',
			'under the influence of alcohol, blood alcohol content up to 0.99 ‰',
			'under the influence of drugs, narcotics',
			'suicide attempt, suicide',
			'tired, fell asleep, sudden physical indisposition',
			'the driver died while driving (heart attack, etc.)',
		],
		'<i class="fa-solid fa-person-falling-burst fa-fw me-2"></i> Consequence': [
			'without injury',
			'minor injury',
			'major injury',
			'death',
			'unknown'
		],
		'<i class="fa-solid fa-road-circle-exclamation fa-fw me-2"></i> Road Condition': [
			'different state of the road surface at the time of accidents',
			'mud on the road',
			'ice on the road - untreated',
			'ice on the road - treated',
			'sudden change in road conditions (frost on the bridge, local frost)',
			'wet surface',
			'dry surface, clean',
			'dry surface, dirty (sand, dust, leaves, gravel etc.)',
			'continuous snow layer, slush'
		],
		'<i class="fa-solid fa-cloud fa-fw me-2"></i> Weather Condition': [
			'rain',
			'different difficult weather conditions',
			'fog',
			'beginning of the rain, light rain, drizzling etc.',
			'normal weather conditions',
			'gusting wind (side wind, whirlwind etc.)',
			'snowfall',
			'frost, icicles are formed'
		],
		'<i class="fa-solid fa-smog fa-fw me-2"></i> Visibility': [
			'at night - without public lighting, visibility unimpaired due to weather conditions',
			'at night - without public lighting, visibility impaired due to weather conditions (fog, rain, snowfall etc.)',
			'at night - with public lighting, visibility unimpaired due to weather conditions',
			'at night - with public lighting, visibility impaired due to weather conditions (fog, rain, snowfall etc.)',
			'during the day, visibility not impaired  weather conditions',
			'during the day, reduced visibility (dawn, dusk)',
			'during the day, poor visibility due to weather conditions (fog, snow, rain, etc.)'
		],
		'<i class="fa-solid fa-eye fa-fw me-2"></i> View Condition': [
			'good view',
			'bad view - other reason',
			'view blocked by a stationary vehicle',
			'bad view - due to surrounding construction (buildings, full railings, etc.)',
			'bad view - due to the course of the road, or the longitudinal profile or routing (unclear top of the climb, road cut, etc.)',
			'bad view - due to vegetation - temporary (grass, grain etc.)',
			'bad view - due to vegetation - permanent (trees, bushes, etc.)'
		],
		'<i class="fa-solid fa-location-pin fa-fw me-2"></i> Location': [
			'bridge, overpass, underpass, tunnel',
			'parking lot adjacent to the road',
			'pedestrain crossing',
			'near a pedestrian crossing (within 20 m)',
			'exit from the parking lot, forest path, etc.',
			'tram, bus, trolleybus stop with a boarding island',
			'tram, bus, trolleybus stop without a boarding island',
			'fuel pump',
			'railway crossing not secured by barriers or light warning devices',
			'railway crossing secured',
			'none of the above'
		],
		'<i class="fa fa-road fa-fw me-2"></i> Road Type': [
			'highway',
			'local road',
			'controlled road (in specific areas)',
			'specific-purpose road - others(parking, rest areas, etc.)',
			'specific-purpose road - field and forest roads, etc.',
			'1st class roads',
			'2nd class roads',
			'3rd class roads',
			'road junction (crossroad controlled in specific areas)'
		],
		'<i class="fa fa-truck-plane fa-fw me-2"></i> Vehicle Type': [
			'bus',
			'pedestrian',
			'other motor vehicle (agricultural, forestry, construction machinery, etc.)',
			'other non-motor vehicle',
			'other vehicle type',
			'bicycle',
			'small motorcycle (up to 50 cc)',
			'moped',
			'motorcycle (including sidecars, scooters, etc.)',
			'unknown, driver left the scene',
			'truck (including multicar, truck crane, tanker, etc.)',
			'truck with semi-trailer',
			'truck with trailer',
			'car with without trailer',
			'car with trailer',
			'carriage, horse riding',
			'tractor (also with trailer)',
			'tram',
			'trolley',
			'train'
		],
		'<i class="fa-solid fa-coins fa-fw me-2"></i> Material Damage Price': [0, 5360000],
		'<i class="fa-solid fa-user-injured fa-fw me-2"></i> Number of Minor Injuries': [0, 29],
		'<i class="fa-solid fa-truck-medical fa-fw me-2"></i> Number of Major Injuries': [0, 14],
		'<i class="fa-solid fa-skull-crossbones fa-fw me-2"></i> Number of Casualties': [0, 3]
	}
	generateFilterControl();


</script>
</body>
</html>
